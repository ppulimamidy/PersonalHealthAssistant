services:
  # Redis for caching and session management
  redis:
    image: redis:7-alpine
    container_name: nutrition-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Auth Service
  auth-service:
    build:
      context: .
      dockerfile: apps/auth/Dockerfile
    container_name: nutrition-auth-service
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql://postgres:your-super-secret-and-long-postgres-password@postgres-health-assistant:5432/health_assistant
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET_KEY=your-super-secret-jwt-key-for-development-only
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=15
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
      - CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=["GET","POST","PUT","DELETE","OPTIONS"]
      - CORS_ALLOW_HEADERS=["*"]
    ports:
      - "8000:8000"
    depends_on:
      - redis
    volumes:
      - ./apps/auth:/app/apps/auth
      - ./common:/app/common
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # User Profile Service
  user-profile-service:
    build:
      context: .
      dockerfile: apps/user_profile/Dockerfile
    container_name: nutrition-user-profile-service
    environment:
      - ENVIRONMENT=development
      - DATABASE_URL=postgresql://postgres:your-super-secret-and-long-postgres-password@postgres-health-assistant:5432/health_assistant
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET_KEY=your-super-secret-jwt-key-for-development-only
      - CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=["GET","POST","PUT","DELETE","OPTIONS"]
      - CORS_ALLOW_HEADERS=["*"]
    ports:
      - "8001:8001"
    depends_on:
      - redis
    volumes:
      - ./apps/user_profile:/app/apps/user_profile
      - ./common:/app/common
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nutrition Service
  nutrition-service:
    build:
      context: .
      dockerfile: apps/nutrition/Dockerfile
    container_name: personalhealthassistant-nutrition-service
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=INFO
      - DATABASE_URL=postgresql://postgres:your-super-secret-and-long-postgres-password@postgres-health-assistant:5432/health_assistant
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=your-super-secret-jwt-key-for-development-only
      - ALLOWED_HOSTS=["localhost", "127.0.0.1", "nutrition-service", "nutrition.localhost"]
      - CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080", "http://localhost:5173"]
      - PROMETHEUS_ENABLED=true
      - GRAFANA_ENABLED=true
      - AUTH_SERVICE_URL=http://auth-service:8000
      - USER_PROFILE_SERVICE_URL=http://user-profile-service:8001
      - HEALTH_TRACKING_SERVICE_URL=http://health-tracking-service:8002
      - MEDICAL_ANALYSIS_SERVICE_URL=http://medical-analysis-service:8006
      - GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY:-your_google_vision_api_key_here}
      - AZURE_VISION_API_KEY=${AZURE_VISION_API_KEY:-your_azure_vision_api_key_here}
      - NUTRITIONIX_API_KEY=${NUTRITIONIX_API_KEY:-}
      - NUTRITIONIX_APP_ID=${NUTRITIONIX_APP_ID:-}
      - USDA_API_KEY=${USDA_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - MAX_IMAGE_SIZE=10485760
      - SUPPORTED_IMAGE_FORMATS=["jpeg", "jpg", "png", "webp", "heic"]
      - IMAGE_UPLOAD_DIR=/app/uploads/nutrition
      - CACHE_ENABLED=true
      - CACHE_TTL=3600
    ports:
      - "8007:8007"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
      - ./cache:/app/cache
    depends_on:
      - redis
      - auth-service
      - user-profile-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nutrition.rule=Host(`nutrition.localhost`)"
      - "traefik.http.routers.nutrition.entrypoints=web"
      - "traefik.http.services.nutrition.loadbalancer.server.port=8007"
      - "traefik.http.middlewares.nutrition-cors.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.nutrition-cors.headers.accesscontrolalloworiginlist=http://localhost:3000,http://localhost:8080,http://localhost:5173"
      - "traefik.http.middlewares.nutrition-cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.nutrition-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.routers.nutrition.middlewares=nutrition-cors"
    restart: unless-stopped

volumes:
  redis_data: 