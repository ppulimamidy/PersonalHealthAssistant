name: Deploy Production

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Test backend before deployment
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r apps/mvp_api/requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          pytest apps/mvp_api/tests/ -v --cov=apps/mvp_api --cov-report=term-missing || true
        continue-on-error: true

  # Test frontend before deployment
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Type check
        run: npm run type-check
        continue-on-error: true

      - name: Lint
        run: npm run lint
        continue-on-error: true

      - name: Build test
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

  # Build and push Docker image for backend
  build-backend:
    name: Build Backend Docker Image
    runs-on: ubuntu-latest
    needs: [test-backend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/mvp-api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/mvp_api/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # Deploy backend to Render
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: [build-backend]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    steps:
      - name: Trigger Render Deployment
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "âœ… Render deployment triggered"
          else
            echo "âš ï¸ RENDER_DEPLOY_HOOK_URL not configured"
            echo "To enable automatic deployment:"
            echo "1. Create a Web Service on Render"
            echo "2. Go to Settings > Deploy Hook"
            echo "3. Add the hook URL to GitHub Secrets as RENDER_DEPLOY_HOOK_URL"
          fi

      - name: Wait for deployment
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 30

      - name: Health check
        run: |
          if [ -n "${{ secrets.BACKEND_URL }}" ]; then
            max_attempts=10
            attempt=0
            while [ $attempt -lt $max_attempts ]; do
              if curl -f "${{ secrets.BACKEND_URL }}/health" > /dev/null 2>&1; then
                echo "âœ… Backend is healthy!"
                exit 0
              fi
              attempt=$((attempt + 1))
              echo "â³ Attempt $attempt/$max_attempts failed, retrying..."
              sleep 10
            done
            echo "âŒ Backend health check failed after $max_attempts attempts"
            exit 1
          else
            echo "âš ï¸ BACKEND_URL not configured, skipping health check"
          fi
        continue-on-error: true

  # Deploy frontend to Vercel
  deploy-frontend:
    name: Deploy Frontend to Vercel
    runs-on: ubuntu-latest
    needs: [test-frontend]
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel Environment Information
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          else
            echo "âš ï¸ VERCEL_TOKEN not configured"
            echo "To enable automatic deployment:"
            echo "1. Install Vercel CLI: npm i -g vercel"
            echo "2. Run: vercel login"
            echo "3. Run: vercel link"
            echo "4. Get token from: https://vercel.com/account/tokens"
            echo "5. Add token to GitHub Secrets as VERCEL_TOKEN"
            echo "6. Add VERCEL_ORG_ID and VERCEL_PROJECT_ID to GitHub Secrets"
          fi
        continue-on-error: true

      - name: Build Project Artifacts
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          fi
        continue-on-error: true
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel
        run: |
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
            echo "âœ… Frontend deployed to Vercel"
          else
            echo "âš ï¸ Vercel deployment skipped - secrets not configured"
          fi
        continue-on-error: true
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Deployment summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend (Render) | ${{ needs.deploy-backend.result == 'success' && 'âœ… Deployed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend (Vercel) | ${{ needs.deploy-frontend.result == 'success' && 'âœ… Deployed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If deployment secrets are not configured yet:" >> $GITHUB_STEP_SUMMARY
          echo "1. Set up backend on Render and add RENDER_DEPLOY_HOOK_URL" >> $GITHUB_STEP_SUMMARY
          echo "2. Set up frontend on Vercel and add VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID" >> $GITHUB_STEP_SUMMARY
          echo "3. Add BACKEND_URL for health checks" >> $GITHUB_STEP_SUMMARY
          echo "4. Configure environment variables on both platforms" >> $GITHUB_STEP_SUMMARY
